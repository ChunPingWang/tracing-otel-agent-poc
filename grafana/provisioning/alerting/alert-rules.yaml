apiVersion: 1

groups:
  - orgId: 1
    name: ecommerce-service-alerts
    folder: E-Commerce Alerts
    interval: 30s
    rules:
      # =====================================================================
      # Rule 1: High Error Rate (> 5%)
      # =====================================================================
      - uid: high-error-rate
        title: "High Error Rate"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              expr: "sum(rate(http_server_duration_milliseconds_count{http_status_code=~\"5..\"}[5m])) by (service_name) / sum(rate(http_server_duration_milliseconds_count[5m])) by (service_name) * 100"
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              conditions:
                - evaluator:
                    params:
                      - 5
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              refId: C
              type: threshold
        for: 1m
        noDataState: OK
        execErrState: Error
        labels:
          severity: critical
        annotations:
          summary: "High error rate on {{ index $labels \"service_name\" }}"
          description: "Service {{ index $labels \"service_name\" }} has error rate of {{ $values.B.Value }}% (threshold: 5%)."

      # =====================================================================
      # Rule 2: High Response Latency p95 (> 2000ms)
      # =====================================================================
      - uid: high-latency-p95
        title: "High Response Latency (p95)"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              expr: "histogram_quantile(0.95, sum(rate(http_server_duration_milliseconds_bucket[5m])) by (le, service_name))"
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              conditions:
                - evaluator:
                    params:
                      - 2000
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              refId: C
              type: threshold
        for: 1m
        noDataState: OK
        execErrState: Error
        labels:
          severity: warning
        annotations:
          summary: "High p95 latency on {{ index $labels \"service_name\" }}"
          description: "Service {{ index $labels \"service_name\" }} has p95 latency of {{ $values.B.Value }}ms (threshold: 2000ms)."

      # =====================================================================
      # Rule 3: JVM Heap Memory Pressure (> 80%)
      # =====================================================================
      - uid: jvm-heap-pressure
        title: "JVM Heap Memory Pressure"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              expr: "sum(process_runtime_jvm_memory_usage_bytes{type=\"heap\"}) by (service_name) / sum(process_runtime_jvm_memory_limit_bytes{type=\"heap\"}) by (service_name) * 100"
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              conditions:
                - evaluator:
                    params:
                      - 80
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              refId: C
              type: threshold
        for: 2m
        noDataState: OK
        execErrState: Error
        labels:
          severity: warning
        annotations:
          summary: "JVM heap pressure on {{ index $labels \"service_name\" }}"
          description: "Service {{ index $labels \"service_name\" }} heap usage is {{ $values.B.Value }}% (threshold: 80%)."

      # =====================================================================
      # Rule 4: Kafka Consumer Lag High (> 1000)
      # =====================================================================
      - uid: kafka-consumer-lag
        title: "Kafka Consumer Lag High"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              expr: "kafka_consumer_records_lag_max"
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              refId: B
              type: reduce
          - refId: C
            datasourceUid: __expr__
            relativeTimeRange:
              from: 0
              to: 0
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              conditions:
                - evaluator:
                    params:
                      - 1000
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              refId: C
              type: threshold
        for: 2m
        noDataState: OK
        execErrState: Error
        labels:
          severity: warning
        annotations:
          summary: "Kafka consumer lag high"
          description: "Consumer lag is {{ $values.B.Value }} records (threshold: 1000)."
